---
import { getCollection } from 'astro:content';
import { formatBlogPosts } from '~/js/utils';
import { Icon } from 'astro-icon/components';
import MobileLink from './MobileLink.astro';

import MobileLinkChild from './MobileLinkChild.astro';
import MenuDropdown from './MenuDropdown.astro';
import siteInfo from '~/data/site';
import Social from './Social.astro';
import ThemeIcon from './ThemeIcon.astro';

const allPosts = await getCollection('work');

const formattedPosts = formatBlogPosts(allPosts, {
    filterOutDrafts: true,
    filterOutFuturePosts: true,
    sortByDate: true,
});

interface Props {
    class?: string;
    isHeroDark: boolean;
}

const pathname = new URL(Astro.request.url).pathname;
const currentPath =
    pathname.slice(-1) === '/' ? pathname.slice(0, -1) : pathname;

const { class: ClassName, isHeroDark = false } = Astro.props;
const year = new Date().getFullYear();
---

<div
    class="fixed inset-0 overflow-hidden xl:hidden"
    x-cloak
    x-show="isMobileNavOpen"
    @click.away="isMobileNavOpen = false"
>
    <div class="fixed inset-0"></div>
    <div class="fixed inset-y-0 right-0 w-full max-w-[85vw] shadow-lg">
        <div
            x-show="isMobileNavOpen"
            @click.away="isMobileNavOpen = false"
            x-transition:enter="transition duration-1000"
            x-transition:enter-start="-translate-x-fl-space-3xl"
            x-transition:enter-end="translate-x-0"
            x-transition:leave="transition duration-1000"
            x-transition:leave-start="translate-x-0"
            x-transition:leave-end="-translate-x-fl-space-3xl"
            class="h-full w-full"
        >
            <div
                class="flex h-full flex-col justify-between overflow-y-auto px-fl-space-m py-fl-space-s"
            >
                <div class="flex justify-between">
                    <a href="/" aria-label="byPete - home">
                        <Icon
                            name="bypete__brand"
                            title="byPete logo"
                            class="h-fl-space-l w-auto !shadow-brand-dark"
                        />
                    </a>
                    <button
                        @click.prevent="isMobileNavOpen = !isMobileNavOpen"
                        class="flex h-fl-space-l w-fl-space-l items-center rounded-sm text-content-light transition duration-200 ease-in-out hover:bg-gray-700 hover:text-white focus:bg-gray-700 focus:text-white focus:outline-none"
                        x-bind:aria-label="'Close main menu'"
                        type="button"
                        aria-label="Main menu"
                        x-bind:aria-expanded="isMobileNavOpen"
                        ><Icon name="lucide:x" class="h-full w-full" />
                    </button>
                </div>
                <nav id="mobilenavigation">
                    <ul x-ref="menu" class="my-fl-space-m self-center">
                        <li>
                            <MobileLink
                                url={`/about/`}
                                title="About"
                                {pathname}
                            />
                        </li>
                        <li
                            x-data="{ isOpen: false}"
                            x-id="['accordion-header-id', 'accordion-panel-id']"
                            :aria-expanded="isOpen"
                        >
                            <div class="flex items-center justify-between">
                                <MobileLink
                                    url={`/work/`}
                                    title="Work"
                                    {pathname}
                                />
                                <button
                                    class="text-content-light"
                                    aria-label="Expand menu"
                                    :id="$id('accordion-header-id')"
                                    :aria-label="isOpen ? 'Close list' : 'Open list'"
                                    :aria-expanded="isOpen"
                                    :aria-controls="$id('accordion-panel-id')"
                                    @click="isOpen = !isOpen"
                                >
                                    <Icon
                                        name="lucide:x"
                                        title="close icon"
                                        x-bind:class="{'0': isOpen, '-rotate-45': !isOpen}"
                                        class="h-fl-space-m w-fl-space-m text-content-light transition-transform duration-500"
                                    />
                                </button>
                            </div>
                            <ul
                                x-cloak
                                x-ref="children"
                                class="h-0 max-h-[33vh] w-full origin-top overflow-y-scroll transition-all duration-700"
                                :id="$id('accordion-panel-id')"
                                :class="isOpen ? 'overflow-auto ' : 'overflow-hidden pointer-events-none' "
                                :style="isOpen ? {height: `${$refs.children.scrollHeight}px`} : {height: `0px`}"
                            >
                                {
                                    formattedPosts.map((post) => (
                                        <li>
                                            <MobileLinkChild
                                                url={`/${post.collection}/${post.slug}/`}
                                                title={post.data.title}
                                                {pathname}
                                            />
                                        </li>
                                    ))
                                }
                            </ul>
                        </li>

                        <li>
                            <MobileLink
                                url={`/connect/`}
                                title="Connect"
                                {pathname}
                            />
                        </li>
                    </ul>
                </nav>
                <div>
                    <div
                        class="-mx-fl-space-2xs my-fl-space-m flex justify-start"
                    >
                        {
                            siteInfo.socials.map((channel) => (
                                <Social
                                    platform={channel.platform}
                                    url={channel.url}
                                    class="text-content-light hover:text-brand"
                                    name={channel.icon}
                                />
                            ))
                        }
                    </div>
                    <ul
                        class="divide-content-outline grid grid-cols-[auto_1fr] grid-rows-1 justify-start divide-x text-content-light"
                    >
                        <li
                            class="px-fl-space-2xs first:pl-0 last:border-0 last:pr-0"
                        >
                            Â©{year}
                        </li>
                        <li
                            class="px-fl-space-2xs first:pl-0 last:border-0 last:pr-0"
                        >
                            <a href="/about/legal/" class="link"
                                >Legal notices</a
                            >
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
