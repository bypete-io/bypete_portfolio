---
import Lightbox from './Lightbox.astro';

interface LightboxSet {
    title: string;
    image: string;
    class?: string;
    caption?: string;
}

interface DataKeys {
    folder: string;
    [key: string]: LightboxSet[] | string; // Allow for dynamic keys with specific types
}

export interface Props {
    data: Partial<DataKeys>;
    collection: string;
    title: string | ImageMetadata;
    caption?: string | ImageMetadata;
    class?: string | ImageMetadata;
}

const { data, collection } = Astro.props;

const isDataValid = (
    data: Props['data'],
    collection: Props['collection'],
): data is DataKeys => {
    return !!data && !!collection && Array.isArray(data[collection]);
};

const getFolderFiles = (
    data: Props['data'],
    collection: Props['collection'],
    imageFiles: Record<string, ImageMetadata>,
): string[] => {
    if (!isDataValid(data, collection)) {
        console.warn('Invalid data or collection provided to Work component', {
            data,
            collection,
        });
        return [];
    }

    return Object.keys(imageFiles).filter((image) => {
        // Check if the 'image' property exists in the collection array
        const isInCollection =
            Array.isArray(data?.[collection]) &&
            data[collection]!.some(
                (asset) => `../../${data.folder}/${asset.image}` === image,
            );

        // Return true if the condition is satisfied
        return isInCollection;
    });
};

const getImageSrcs = (
    data: Props['data'],
    collection: Props['collection'],
    folderFiles: string[],
    imageFiles: Record<string, ImageMetadata>,
): Array<ImageMetadata & Asset> => {
    return folderFiles.map((image) => {
        const asset = data[collection]?.find(
            (asset) => `../../${data.folder}/${asset.image}` === image,
        );

        if (asset) {
            // Include additional properties from collection in the imageFiles object
            return {
                ...imageFiles[image],
                title: asset.title,
                caption: asset.caption,
                class: asset.class,
            };
        }

        return imageFiles[image];
    });
};

const imageFiles = import.meta.glob<ImageMetadata>(
    '../../assets/work/**/*.{png,webp,jpg,jpeg}',
    {
        import: 'default',
        eager: true,
    },
);

const folderFiles = getFolderFiles(data, collection, imageFiles);
const imageSrcs = getImageSrcs(data, collection, folderFiles, imageFiles);

const gallery = 'work-' + collection;
---

<Lightbox id={gallery} images={imageSrcs}>
    <slot slot="title" name="title" />
    <slot />
</Lightbox>
