---
import { Picture } from 'astro:assets';
import { Icon } from 'astro-icon/components';
import utilities from '~/data/utilities.json';

const {
    src,
    widths = [],
    sizes,
    formats = ['avif', 'webp'],
    breakout = true,
    wrapper = '',
    credit = '',
    ...attrs
} = Astro.props;

const resolvedWidths = widths.length ? widths : [240, 540, 720, src.width];
const resolvedSizes =
    sizes ||
    `(max-width: 360px) 240px, (max-width: 720px) 540px, (max-width: 1600px) 720px, ${src.width}px`;

const imageProps = {
    src,
    ...attrs,
    quality: 'high',
    sizes: resolvedSizes,
    widths: resolvedWidths,
    formats,
};
---

{
    wrapper || breakout == true || credit ? (
        <div
            class:list={[
                'group relative',
                wrapper || '',
                breakout ? utilities.breakout : '',
            ]}
        >
            <Picture {...imageProps} />
            {credit && (
                <div
                    class="absolute bottom-2 left-4 z-50 grid cursor-help grid-cols-credit items-center overflow-hidden rounded-l-full text-left text-white opacity-0 transition-opacity duration-300 group-hover:opacity-100 md:left-8"
                    x-data="{open : false}"
                >
                    <button
                        class="z-10 flex h-8 w-8 items-center justify-center rounded-full bg-accent"
                        @click="open = !open"
                        x-bind:aria-expanded="open ? 'true' : 'false'"
                    >
                        <Icon name="lucide:camera" class="h-4 w-auto" />
                        <span class="sr-only">Show image credit</span>
                    </button>
                    <div
                        class="z-0 -ml-4 origin-left rounded rounded-l-none bg-slate-900/75 py-1 pl-6  pr-2 text-xs"
                        x-cloak
                        x-transition:enter="transition ease-out duration-300"
                        x-transition:enter-start="opacity-0 -translate-x-24"
                        x-transition:enter-end="opacity-100 translate-x-0"
                        x-transition:leave=" transition ease-in duration-300"
                        x-transition:leave-start="opacity-100"
                        x-transition:leave-end="opacity-0"
                        x-show="open"
                    >
                        Credit: <Fragment set:html={credit} />
                    </div>
                </div>
            )}
        </div>
    ) : (
        <Picture {...imageProps} />
    )
}
