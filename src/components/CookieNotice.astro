---
import Toast from './ui/Toast.astro';
import Button from './ui/Button.astro';
import Link from './ui/Link.astro';
import siteInfo from '~/data/site';
import { Icon } from 'astro-icon/components';

const build = import.meta.env.MODE;
let domain: string;

if (build === 'production') {
    domain = siteInfo.domain.live;
} else if (build === 'staging') {
    domain = siteInfo.domain.staging;
} else {
    domain = 'localhost';
}
const isSecure = ['production', 'staging'].includes(build);
---

<Toast>
    <div
        class="pointer-events-auto grid items-start gap-y-fl-space-xs p-fl-space-xs grid-areas-toast"
        x-data={`cookie({ domain: '${domain}', isSecure: '${isSecure}'})`}
        x-show="toastCookie"
        x-transition:enter="transition ease-out duration-150"
        x-transition:enter-start="opacity-0 "
        x-transition:enter-end="opacity-100 "
        x-transition:leave="transition ease-in duration-300"
        x-transition:leave-start="opacity-100 "
        x-transition:leave-end="opacity-0 "
    >
        <div class="text-fl-step--1 grid-in-message">
            <p>
                We use cookies to learn how visitors interact with our site. By
                continuing to browse you agree to the use of these cookies.
            </p>
        </div>
        <button
            type="button"
            title="hide"
            @click="freeze(false)"
            class="-mr-fl-space-s -mt-fl-space-s rounded-full bg-warning-light p-fl-space-3xs text-white shadow-floated grid-in-close hover:bg-warning-dark"
        >
            <Icon name="mdi:hide" class="h-4 w-auto" />
        </button>
        <p class="flex justify-between grid-in-action">
            <Link theme="link" size="sm" href="/about/legal/#cookie-policy">
                Cookie policy
            </Link>
            <Button
                type="button"
                size="sm"
                @click="accept()"
                aria-label="Dismiss"
            >
                OK, continue
            </Button>
        </p>
    </div>
</Toast>

<script>
    import Alpine from 'alpinejs';
    import Cookies from 'js-cookie';

    document.addEventListener('alpine:init', () => {
        Alpine.data('cookie', (build = {}) => ({
            cookie: '',
            name: 'cnotice',
            domain: build.domain,
            isSecure: build.isSecure || false,
            toastCookie: false,
            freeze(freezeState) {
                this.toastCookie = freezeState;
                document.body.classList.toggle('overflow-hidden', freezeState);
                this.$dispatch('show-overlay', { visible: freezeState });
            },
            init() {
                setTimeout(() => {
                    this.cookie = Cookies.get(this.name);
                    if (!this.cookie) {
                        this.freeze(true);
                    }
                }, 6000);
            },
            accept() {
                this.freeze(false);
                const config = {
                    expires: 365,
                    path: '/',
                    secure: this.isSecure,
                    sameSite: 'strict',
                };

                if (this.isSecure && this.domain) {
                    config.domain = this.domain; // Include domain only for production or staging
                }

                Cookies.set(this.name, 'true', config);
            },
        }));
    });
</script>
